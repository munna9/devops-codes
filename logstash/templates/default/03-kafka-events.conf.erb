#<%=node['phenom']['banner']%>
filter {
  if [type] == "kafka-events" {
    ruby {
      code => "
        require 'json'
        require 'set'
        event_traits = {
          'default_traits' => ['trait2','trait65','trait79','trait76','trait253'],
          'logo_click' =>'[]',
        	'footer_logo_click' => '[]',
        	'header_menu_click' => ['trait62'],
        	'footer_menu_click' => ['trait62'],
        	'join_talent_community_click' => '[]',
        	'recommended_job_see_more_click' => '[]',
        	'linkedin_recommended_jobs_see_more_click' => '[]',
        	'linkedin_recommended_jobs_see_less_click' => '[]',
        	'recommended_job_see_less_click' => '[]',
        	'jtn_form_submit' => ['form_step_data','trait27','trait145'],
        	'jtc_form_submit' => ['form_step_data','trait27','trait145'],
        	'socialnetwork_menu_click' => ['trait213'],
        	'page_search' => ['trait6'],
        	'search_icon_click' => '[]',
        	'registration_click' =>'[]',
        	'header_search' => ['trait6'],
        	'home_page_view' => '[]',
        	'job-cart-icon-click' => '[]',
        	'type_ahead_search' => ['trait59','trait60'],
        	'linkedin_login_click' => '[]',
        	'recommended_job_click' => ['trait14','trait5'],
        	'recently_viewed_job_click' => ['trait5','trait14'],
        	'view_all_glassdoor_reviews_click' => '[]',
        	'glassdoor_review_click' =>'[]',
        	'favorites_page_view' => '[]',
        	'favorite_job_click' => ['trait5','trait14'],
        	'job_add_to_favorite' => ['trait5','trait14'],
        	'job_unfavorited' => ['trait5','trait14'],
        	'job_category_page_view' => ['trait14'],
        	'sort_by_click' => ['trait61'],
        	'search_result_page_view' => '[]',
        	'refiner_search' => ['trait6','trait47'],
        	'clear_searches_click' => '[]',
        	'pagination_click' => ['trait214'],
        	'job_click' => ['trait5','trait14'],
        	'job_details_view' => ['trait5','trait14'],
        	'job_added_to_jobcart' => ['trait5','trait14'],
        	'similar_jobs_subscribe' => ['trait5','trait14','trait27'],
        	'Share_Facebook' => ['trait5','trait14'],
        	'Share_LinkedIn' => ['trait5','trait14'],
        	'Share_Twitter' => ['trait5','trait14'],
        	'Share_Googleplus' =>['trait5','trait14'],
        	'Share_Email' =>['trait5','trait14'],
        	'Share_SMS' =>['trait5','trait14'],
        	'similar_job_click' =>['trait5','trait14','trait12'],
        	'email_job' =>['trait5','trait15','trait27','trait14'],
        	'ats_apply_click' =>['trait5','trait14'],
        	'apply_click' =>['trait5','trait14'],
        	'quick_apply_email_popup_close_click' =>['trait5','trait14'],
        	'apply_email_submit_click' =>['trait5','trait27'],
        	'back_to_search_results_click' =>'[]',
        	'previous_job_click' =>['trait5','trait14'],
        	'next_job_click' =>['trait5','trait14'],
        	'recommendation_dot_slider_click' =>'[]',
        	'recommendation_next_slider_click' =>'[]',
        	'locations_next_slider_click' =>'[]',
        	'locations_previous_slider_click' =>'[]',
        	'recommendation_previous_slider_click' =>'[]',
        	'recently_viewed_jobs_previous_slider_click' =>['trait5'],
        	'recently_viewed_jobs_next_slider_click' =>['trait5'],
        	'recently_viewed_jobs_slider_dots_click' =>['trait5'],
        	'static_more_info' =>['trait13'],
        	'errorpage_category_click' =>['trait14'],
        	'job_category_click' =>['trait14'],
        	'job_category_search_click' =>['trait14'],
        	'linkedin_profile_data' =>['trait_liProfile'],
        	'linkedin_logout_click' =>'[]',
        	'ats_apply_page_view' =>['trait5','trait27'],
        	'apply_page_view' =>['trait5','trait27'],
        	'apply_step_submit' =>['trait254','trait5','form_step_data','trait14','trait27'],
        	'apply_login_click' =>['trait254','trait5','form_step_data','trait14'],
        	'apply_service_data' =>['trait254','trait5','form_step_data','trait14','stepStatus','trait132','trait27'],
        	'apply_form_submit' =>['trait254','trait5','form_step_data','trait14','trait27'],
        	'404_page_view' =>'[]',
        	'back_to_top_button_click' =>'[]',
        	'static_page_view' =>['trait13'],
        	'category_click' =>['trait14'],
        	'static_content_click' =>['trait13'],
        	'career_alerts_popup_close_click' =>'[]',
        	'career_alerts_click' =>'[]',
        	'signIn_click' =>'[]',
        	'signature_click' =>'[]',
        	'signUp_click' =>'[]',
        	'business_unit_category_click' =>['trait14'],
        	'featured_category_click' =>['trait14'],
        	'featured_location_click' =>['trait6','trait144'],
        	'targetted_job_click' =>['trait14','trait5','trait144'],
        	'targeted_job_see_more_click' =>'[]',
        	'login_submit' =>['trait27'],
        	'logout_click' =>'[]',
        	'profile_click' =>'[]',
        	'linkedin_recommended_job_click' =>['trait5','trait14'],
        	'near_job_click' =>['trait5','trait14'],
        	'neayby_jobs_see_more_click' =>'[]',
        	'neayby_jobs_see_less_click' =>'[]',
        	'apply_linkedin_click' =>['trait5','trait14','trait254'],
        	'apply_dropbox_click' =>['trait5','trait14','trait254'],
        	'apply_onedrive_click' =>['trait5','trait14','trait254'],
        	'apply_googledrive_click' =>['trait5','trait14','trait254'],
        	'apply_resumeupload_click' =>['trait5','trait14','trait254'],
        	'apply_edit_click' =>['trait257','trait254','trait5','trait14','trait27'],
        	'apply_resumeupload_resume_server_event_data' =>['trait5','trait14','trait254','trait27','trait145','trait132','trait165','trait150'],
        	'apply_googledrive_resume_server_event_data' =>['trait5','trait14','trait254','trait27','trait145','trait132','trait165','trait150'],
        	'apply_dropbox_resume_server_event_data' =>['trait5','trait254','trait150','trait145','trait27','trait165','trait132','trait14'],
        	'apply_linkedin_resume_server_event_data' =>['trait5','trait14','trait27','trait254','trait150','trait165','trait145','trait132'],
        	'apply_onedrive_resume_server_event_data' =>['trait5','trait14','trait27','trait254','trait150','trait165','trait145','trait132'],
        	'jtc_linkedin_resume_server_event_data' =>['trait27','trait254','trait145','trait165','trait77','trait150'],
        	'apply_registration_click' =>['trait5','trait14'],
        	'jtc_googledrive_resume_server_event_data' =>['trait27','trait254','trait145','trait165','trait150'],
        	'jtc_onedrive_resume_server_event_data' =>['trait27','trait254','trait145','trait165','trait150'],
        	'apply_back_to_review_click' =>['trait254','trait5','trait14'],
        	'apply_save_click' =>['trait254','trait5','trait14','trait27'],
        	'apply_breadcrumb_click' =>['trait257','trait254','trait5','trait14','trait27'],
        	'apply_back_click' =>['trait254','trait5','trait14','trait27'],
        	'results_search' =>['trait6'],
        	'jtc_dropbox_click' =>['trait254'],
        	'jtc_dropbox_resume_server_event_data' =>['trait254','trait27'],
        	'jtc_linkedin_click' =>['trait254'],
        	'jtc_googledrive_click' =>['trait254'],
        	'jtc_onedrive_click' =>['trait254'],
        	'jtc_resumeupload_click' =>['trait254'],
        	'jtc_resumeupload_resume_server_event_data' =>['trait254','trait27'],
        	'jtc_service_data' =>['trait254','trait27'],
        	'jtc_thankYou' =>['trait254','trait27'],
        	'linkedin_recommended_category_click' =>['trait14'],
        	'apply_thankYou' =>['trait5','trait14','trait254','trait27','trait145'],
        	'goto_click' =>['trait256'],
        	'manage_career_alert_preferences_click' =>['trait27'],
        	'check_application_status_click' =>['trait27'],
        	'jtc_page_view' =>'[]',
        	'job_category_show_less_click' =>'[]',
        	'glassdoor_photos_tab_click' =>'[]',
        	'required_traits' =>'[]',
        	'glassdoor_reviews_tab_click' =>'[]',
        	'homepage_dot_slider_click' => '[]',
        	'employees_login_click'=>['trait5','trait14'],
        	'job_category_next_slider_click'=>'[]',
        	'job_category_previous_slider_click'=>'[]',
        	'banner_video_click'=>['trait212'],
        	'job_category_view_next_click'=>'[]',
        	'jobs_by_location_click'=>['trait144'],
        	'menu_icon_click'=>'[]',
        	'employee_review_previous_slider_click'=>'[]',
        	'employee_review_next_slider_click'=>'[]',
        	'job_category_showless_click'=>'[]',
        	'job_category_showmore_click'=>'[]',
        	'forgot_password_click'=>['trait254','trait5','trait27','trait14'],
        	'change_password_click'=>['trait254','trait5','trait27','trait14'],
        	'photos_on_glassdoor'=>'[]',
        	'apply_alreadyApplied'=>['trait5','trait14','trait254','trait27'],
        	'poweredby_glassdoor_click'=>'[]',
        	'employee_review_next_slider_click'=> '[]',
        	'employee_review_previous_slider_cick'=>'[]',
        	'employee_review_story_click'=>'[]',
        	'employee_story_click'=>'[]',
        	'employee_review_dot_slider_click'=>'[]',
        	'apply_resume_download_click'=>['trait5','trait27','trait14'],
        	'left_menu_click'=>['trait62'],
        	'locale'=>'[]',
        	'talentcommunity_email_submit'=>['trait27'],
        	'career_alerts_signup_click'=>'[]',
        	'search_by_static_link'=>['trait6'],
        	'similar_jobs_see_more_click'=>'[]',
        	'similar_jobs_see_less_click'=>'[]',
        	'results_search_clear_click'=>['trait6'],
        	'reviews_by_glassdoor'=>'[]',
        	'external_account_login'=>['trait213'],
        	'internal_account_login'=>['trait213'],
        	'update_profile_click'=>['trait260'],
        	'persona_click'=>['trait258'],
        	'search_icon_close_click'=>'[]',
        	'menu_icon_close_click'=>'[]',
        	'apply_user_decline_click'=>['trait5','trait14'],
        	'apply_user_acceptance_click'=>['trait5','trait14'],
        	'apply_employment_details_add_click'=>['trait5','trait14'],
        	'apply_employment_details_remove_click'=>['trait5','trait14'],
        	'apply_education_details_add_click'=>['trait5','trait14'],
        	'apply_education_details_remove_click'=>['trait5','trait14'],
        	'apply_license_details_add_click'=>['trait5','trait14'],
        	'apply_license_details_remove_click'=>['trait5','trait14'],
        	'apply_professional_memberships_details_add_click'=>['trait5','trait14'],
        	'apply_professional_memberships_details_remove_click'=>['trait5','trait14'],
        	'apply_certifications_details_add_click'=>['trait5','trait14'],
        	'apply_certifications_details_remove_click'=>['trait5','trait14'],
        	'apply_language_skills_details_add_click'=>['trait5','trait14'],
        	'apply_language_skills_details_remove_click'=>['trait5','trait14'],
        	'apply_geogreaphic_moblity_details_add_click'=>['trait5','trait14'],
        	'apply_geogreaphic_moblity_details_remove_click'=>['trait5','trait14'],
        	'save_profile'=>'[]',
        	'cancel_profile'=>'[]',
        	'cancel_apply_click'=>['trait14','trait5','trait144'],
        	'resume_download_click'=>'[]',
        	'resume_remove_click'=>'[]',
        	'resume_upload_click'=>'[]',
        	'saved_jobs_tab_click'=>'[]',
        	'profile_tab_click'=>'[]',
        	'action_center_tab_click'=>'[]',
        	'apply_history_tab_click'=> '[]',
        	'travel_request_tab_click'=> '[]',
        	'expenses_reimbursment_click'=>'[]',
        	'travel_expenses_info_click'=>'[]',
        	'travel_request_cancel_click'=>'[]',
        	'travel_request_submit_click'=>'[]',
        	'remove_education_details'=>'[]',
        	'remove_employment_details'=>'[]',
        	'remove_address_details'=>'[]',
        	'remove_contact_details'=>'[]',
        	'add_contact_details'=>'[]',
        	'contact_recruiter_click'=>'[]',
        	'contactus_region_click'=>['trait260','trait264'],
        	'add_address_details'=>'[]',
        	'add_website_url_click'=>'[]',
        	'remove_website_url_click'=>'[]',
        	'add_employment_details'=>'[]',
        	'add_education_details'=>'[]',
        	'remove_skills_details'=>'[]',
        	'add_skills_details'=>'[]',
        	'local_drive_click'=>['trait145'],
        	'dropbox_click'=>['trait145'],
        	'onedrive_click'=>['trait145'],
        	'googledrive_click'=>['trait145'],
        	'content_modal_read_more_click'=>['trait13'],
        	'content_modal_read_less_click'=>['trait13'],
        	'view_all_jobs_click'=>'[]',
        	'profile_import_options_close_click'=>'[]',
        	'back_to_login_click'=>'[]',
        	'read_all_reviews_click'=>['trait13'],
        	'add_expenses_click'=>'[]',
        	'remove_expenses_click'=>'[]',
        	'travel_policy_click'=>'[]',
        	'amex_privacy_statement_click'=>'[]',
        	'create_travel_request_click'=>'[]',
        	'receipts_click'=>'[]',
        	'receipts_download_click'=>'[]',
        	'receipts_remove_click'=>'[]',
        	'user_acceptance_click'=>'[]',
        	'update_expenses_total_click'=>'[]',
        	'expenses_reimbursment_cancel_click'=>'[]',
        	'expenses_reimbursment_submit_click'=>'[]',
        	'documents_upload_click'=>'[]',
        	'receipts_upload_click'=>'[]',
        	'attachments_remove_click'=>'[]',
        	'remove_receipts_click'=>'[]',
        	'download_receipts_click'=>'[]',
        	'attachments_download_click'=> '[]',
        	'disability_assistance_click'=>['trait5','trait14'],
        	'interview_tips_click'=>['trait5','trait14'],
        	'frequently_asked_questions_click'=>['trait5','trait14'],
        	'privacy_statement_click'=>'[]',
        	'cookies_policy_click'=>'[]',
        	'registration_submit'=>['trait27'],
        	'registration_cancel'=>'[]',
        	'header_notification_close_click'=>'[]',
        	'continue_apply_click'=>['trait5','trait14'],
        	'job_see_more_click'=>'[]',
        	'job_see_less_click'=>'[]',
        	'withdraw_application_click'=>['trait5','trait14'],
        	'withdraw_application_confirmation_click'=>['trait5','trait14'],
        	'withdraw_application_cancellation_click'=>['trait5','trait14'],
        	'skip_main_content'=>'[]', 	'skip_jobs_content'=> ['trait14'], 'expenses_reimbursment_tab_click' =>'[]',
        	'travel_policy_tab_click'=>'[]',
        	'accept_travel_policy_click'=>'[]',
        	'multi_location_click'=>['trait5','trait14'],
        	'personalized_recommended_job_click'=>['trait5','trait14','trait144'],
        	'refer_someone_click'=>['trait5','trait14','trait144'],
        	'applythankyou_view'=>['trait5'],
        	'partnership_next_slider_click'=>'[]',
        	'partnership_previous_slider_click'=>'[]',
        	'static_content_slider_click'=>['trait260','trait264','trait13'],
        	'apply_next_step_click'=>['trait5','trait14'],
        	'apply_previous_step_click'=>['trait5','trait14'],
        	'user_location_selector_click'=>['trait5','trait14'],
        	'coverletter_upload_click'=>['trait5','trait14'],
        	'coverletter_remove_click'=>'[]',
        	'apply_coverletter_click'=> '[]',
        	'coverletter_upload_click'=>['trait14','trait5','trait145'],
        	'view_all_locations_click'=>'[]',
        	'view_all_categories_click'=>'[]',
          'TimeSpentOnPage' => '[]',
          'widget_impression' => '[]'
        }
        kafka_event_json=event.get('message')
        kafka_event_hash=JSON.parse(kafka_event_json).to_hash
        properties_keys=Set.new
        kafka_new_hash=Hash.new
        kafka_event_hash.each_pair do |main_event,main_data|
          if main_event == 'properties'
            kafka_event_hash['properties'].each_pair do |properties_key,properties_value|
              kafka_new_hash[properties_key]=properties_value
            end
            if event_traits[kafka_event_hash['event']]
              essential_traits=Set.new(event_traits[kafka_event_hash['event']]+event_traits['default_traits'])
              properties_keys=Set.new(kafka_event_hash['properties'].keys())
              unless essential_traits.subset?(properties_keys)
                _missing_traits=(essential_traits-properties_keys).to_a
                _missing_traits=_missing_traits.join(',')
                kafka_new_hash['trait_error_code']=100
                kafka_new_hash['trait_error_message']='Essential traits '+_missing_traits+' missing for '+kafka_event_hash['event']
              end
            end
          elsif main_event == 'location'
            kafka_event_hash['location'].each_pair do |location_key,location_value|
              kafka_new_hash[location_key]=location_value
            end
          elsif main_event == 'isp'
            kafka_event_hash['isp'].each_pair do |isp_key,isp_value|
              kafka_new_hash[isp_key]=isp_value
            end
          else
            kafka_new_hash[main_event]=main_data
          end
        end
        kafka_new_hash.each_pair do |key,value|
          event.set(key,kafka_new_hash[key])
        end
        event.to_hash.keys.each do |k|
          event.remove(k) if k.end_with? '.name'
          event.remove(k) if k.end_with? '.dur'
        end
      "
    }
  }
}
output {
  if [type] == "kafka-events" {
    elasticsearch {
        hosts => ["<%=node['kafka_events']['elasticsearch']['server_name']%>:<%=node['kafka_events']['elasticsearch']['server_port']%>"]
        flush_size => 1000
        idle_flush_time => 100
        template_name => "<%=node['logstash']['template']['name']%>"
        template => "<%=node['logstash']['template']['file']%>"
        index => "phenomtrack-%{+YYYY.MM.dd}"
    }
  }
}
