#<%=node['phenom']['banner']%>
upstream kibana {
<%kibana_hosts.each do |kibana_host| %>
  server <%= kibana_host%>:<%= kibana_port%>;
<%end%>
  keepalive 10;
}

server {
  listen 80;
  server_name <%=node['kibana']['server_name']%>;

  access_log "<%=node['nginx']['app']['log_directory']%>/kibana.access.log";
  error_log "<%=node['nginx']['app']['log_directory']%>/kibana.error.log";

  location /{

    proxy_set_header    Host            $host:$server_port;
    proxy_set_header    X-Real-IP       $remote_addr;
    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto $scheme;

    proxy_pass http://kibana;
    proxy_read_timeout 90;
    proxy_redirect http://kibana http://"<%=node['kibana']['server_name']%>";
  }
}